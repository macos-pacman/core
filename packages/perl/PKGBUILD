# Maintainer: Florian Pritz <bluewind@xinu.at>
# Contributor: Angel Velasquez <angvp@archlinux.org>
# Contributor: kevin <kevin.archlinux.org>
# Contributor: judd <jvinet.zeroflux.org>
# Contributor: francois <francois.archlinux.org>

pkgname=perl
pkgver=5.36.1
_baseversion="${pkgver%.*}"
pkgrel=1
pkgdesc="A highly capable, feature-rich programming language"
arch=('x86_64' 'arm64')
license=('GPL' 'PerlArtistic')
url="https://www.perl.org"
depends=('gdbm>=1.17' 'db5.3' 'glibc' 'libxcrypt' 'libcrypt.dylib')
# NOTE: This array is automatically generated by `./patchprov`.
#       If you want to add entries, do so in the next array.
provides=('perl-archive-tar=2.40'
          'perl-attribute-handlers=1.02'
          'perl-autodie=2.34'
          'perl-autoloader=5.74'
          'perl-autouse=1.11'
          'perl-base=2.27'
          'perl-bignum=0.65'
          'perl-carp=1.52'
          'perl-compress-raw-bzip2=2.103'
          'perl-compress-raw-zlib=2.105'
          'perl-config-perl-v=0.33'
          'perl-constant=1.33'
          'perl-cpan-meta-requirements=2.140'
          'perl-cpan-meta-yaml=0.018'
          'perl-cpan-meta=2.150010'
          'perl-cpan=2.33'
          'perl-data-dumper=2.184'
          'perl-db_file=1.857'
          'perl-devel-ppport=3.68'
          'perl-devel-selfstubber=1.06'
          'perl-digest-md5=2.58'
          'perl-digest-sha=6.02'
          'perl-digest=1.20'
          'perl-dumpvalue=1.21'
          'perl-encode=3.17'
          'perl-encoding-warnings=0.13'
          'perl-env=1.05'
          'perl-experimental=0.028'
          'perl-exporter=5.77'
          'perl-extutils-cbuilder=0.280236'
          'perl-extutils-constant=0.25'
          'perl-extutils-install=2.20'
          'perl-extutils-makemaker=7.64'
          'perl-extutils-manifest=1.73'
          'perl-extutils-parsexs=3.45'
          'perl-extutils-pl2bat=0.004'
          'perl-file-fetch=1.04'
          'perl-file-path=2.18'
          'perl-file-temp=0.2311'
          'perl-filter-simple=0.96'
          'perl-filter-util-call=1.60'
          'perl-findbin=1.53'
          'perl-getopt-long=2.52'
          'perl-http-tiny=0.080'
          'perl-i18n-collate=1.02'
          'perl-i18n-langtags=0.45'
          'perl-if=0.0610'
          'perl-io-compress=2.106'
          'perl-io-socket-ip=0.41'
          'perl-io-zlib=1.11'
          'perl-io=1.50'
          'perl-ipc-cmd=1.04'
          'perl-ipc-sysv=2.09'
          'perl-json-pp=4.07'
          'perl-lib=0.65'
          'perl-libnet=3.13'
          'perl-locale-maketext-simple=0.21_01'
          'perl-locale-maketext=1.31'
          'perl-math-bigint-fastcalc=0.5012'
          'perl-math-bigint=1.999830'
          'perl-math-bigrat=0.2621'
          'perl-math-complex=1.5902'
          'perl-memoize=1.03_01'
          'perl-mime-base64=3.16'
          'perl-module-corelist=5.20220520'
          'perl-module-load-conditional=0.74'
          'perl-module-load=0.36'
          'perl-module-loaded=0.08'
          'perl-module-metadata=1.000037'
          'perl-net-ping=2.74'
          'perl-params-check=0.38'
          'perl-parent=0.238'
          'perl-pathtools=3.84'
          'perl-perl-ostype=1.010'
          'perl-perlfaq=5.20210520'
          'perl-perlio-via-quotedprint=0.09'
          'perl-pod-checker=1.74'
          'perl-pod-escapes=1.07'
          'perl-pod-perldoc=3.2801'
          'perl-pod-simple=3.43'
          'perl-pod-usage=2.01'
          'perl-podlators=5.008'
          'perl-safe=2.43'
          'perl-scalar-list-utils=1.62'
          'perl-search-dict=1.07'
          'perl-selfloader=1.26'
          'perl-socket=2.033'
          'perl-storable=3.26'
          'perl-sys-syslog=0.36'
          'perl-term-ansicolor=5.01'
          'perl-term-cap=1.17'
          'perl-term-complete=1.403'
          'perl-term-readline=1.17'
          'perl-test-harness=3.44'
          'perl-test-simple=1.302190'
          'perl-test=1.31'
          'perl-text-abbrev=1.02'
          'perl-text-balanced=2.04'
          'perl-text-parsewords=3.31'
          'perl-text-tabs=2021.0814'
          'perl-thread-queue=3.14'
          'perl-thread-semaphore=2.13'
          'perl-threads-shared=1.64'
          'perl-threads=2.27'
          'perl-tie-file=1.06'
          'perl-tie-refhash=1.40'
          'perl-time-hires=1.9770'
          'perl-time-local=1.30'
          'perl-time-piece=1.3401'
          'perl-unicode-collate=1.31'
          'perl-unicode-normalize=1.31'
          'perl-version=0.9929'
          'perl-xsloader=0.31')
# Add your own provides here
provides=("${provides[@]}")
source=(https://www.cpan.org/src/5.0/perl-${pkgver}.tar.xz
        db_config.in
        perlbin.sh.in
        perlbin.csh.in
        perlbin.fish.in
        detect-old-perl-modules.sh.in
        detect-old-perl-modules.hook.in
        skip-broken-locale-tests.patch)
options=('makeflags' '!purge' 'emptydirs')
sha512sums=('8d1ec654c59d078bfc477f11c9526233199a85e4d4f6f5a55bf9eb7802cd355189c669cc6785d2d5e741c1de4d740b7a0cfd3c0198122586a07ac7f527fb14af'
            '91a833313e87723dd813d316b799875b8414ba9364575aaebe9b543d45cc3549f7d72d2ebda7b27d1c02f2656e8785bbd47576c172da78853492acc9b22f82cc'
            'a2b9eb8bedaffd2fe954d26e15b40fd609683b56671332dc1cb72b031d7dbed3d3d133e9d383599bacbda7227c36779247c29e8b5590d1ad8199ad8810f31d5c'
            '950c193841f9fd4016c952a0ddccb2f0e67325241a8321ebedf9a0d26703b36efee130ccaa02ba7af284867278e56e9c9c0c123b95fab1175cc645b91ac18054'
            'aa9655a632271d3da47200f1d402e65b4a9341f545b58636076954c5c5a9ee090f781d6f1207226e7655c434f5bf827c1f4fdc7729aee19278857fd13dd520dc'
            '5b96d373ff5157fd809c010339551225759a04de73904140a5ae279e24f8fb203022b35f289c832760811623438d1fea857a459db2ed7172807d079f8058c42b'
            '8798a15de88d77adc7f33797624baba89e8e22973ac23b9ec3061a881a0698a96c6d15a833004a4da4fefc2ccc31e4eb3d1228f9a4c415214bf27517bf12c5bd'
            '17010ef399b2a0ad5eaffb2ffbc7b4299f162971db72128688b355e4e4bd32bb06f206b799a60504aa7a98f3b31a6a2feeb620c011a7bea5c6757ff88f8a17b0')
# https://www.cpan.org/src/5.0/perl-$pkgver.tar.xz.sha256.txt

prepare() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  patch -Np1 -i ../skip-broken-locale-tests.patch

  rm -f ./cpan/DB_File/config.in
  sed -e "s|%%PACMAN_ROOT%%|${pacman_root}|g" ../db_config.in > ./cpan/DB_File/config.in
  sed -e "s|%%PACMAN_ROOT%%|${pacman_root}|g" ../perlbin.sh.in > ../perlbin.sh
  sed -e "s|%%PACMAN_ROOT%%|${pacman_root}|g" ../perlbin.csh.in > ../perlbin.csh
  sed -e "s|%%PACMAN_ROOT%%|${pacman_root}|g" ../perlbin.fish.in > ../perlbin.fish

  sed -e "s|%%PACMAN_ROOT%%|${pacman_root}|g" -e "s|%%PACMAN_ROOT_REL%%|${pacman_root#/}|g" ../detect-old-perl-modules.hook.in > ../detect-old-perl-modules.hook
  sed -e "s|%%PACMAN_ROOT%%|${pacman_root}|g" ../detect-old-perl-modules.sh.in > ../detect-old-perl-modules.sh
}

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  if [ "${CARCH}" = "x86_64" ]; then
    # for x86_64
    arch_opts="-Dcccdlflags='-fPIC'"
  else
    # for i686
    arch_opts=""
  fi

  export TZ=UTC
  ./Configure \
    -des -Dusethreads -Duseshrplib -Duselargefiles -Doptimize="${CFLAGS}" \
    -Dcc=clang \
    -Dprefix=${pacman_root}/usr \
    -Dvendorprefix=${pacman_root}/usr \
    -Dprivlib=${pacman_root}/usr/share/perl5/core_perl \
    -Darchlib=${pacman_root}/usr/lib/perl5/$_baseversion/core_perl \
    -Dsitelib=${pacman_root}/usr/share/perl5/site_perl \
    -Dsitearch=${pacman_root}/usr/lib/perl5/$_baseversion/site_perl \
    -Dvendorlib=${pacman_root}/usr/share/perl5/vendor_perl \
    -Dvendorarch=${pacman_root}/usr/lib/perl5/$_baseversion/vendor_perl \
    -Dscriptdir=${pacman_root}/usr/bin/core_perl \
    -Dsitescript=${pacman_root}/usr/bin/site_perl \
    -Dvendorscript=${pacman_root}/usr/bin/vendor_perl \
    -Dinc_version_list=none \
    -Dman1ext=1perl -Dman3ext=3perl ${arch_opts}
  make
}

check() {
  cd "${srcdir}/${pkgname}-${pkgver}"
#  TEST_JOBS=$(echo "$MAKEFLAGS" | sed 's/.*-j\([0-9][0-9]*\).*/\1/') make test_harness

  # some tests fail despite my best efforts. they're all locale stuff
  make test || true
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  make DESTDIR="$pkgdir" install

  ### Perl Settings ###
  # Change man page extensions for site and vendor module builds.
  # Set no mail address since bug reports should go to the bug tracker
  # and not someone's email.
  sed -e '/^man1ext=/ s/1perl/1p/' -e '/^man3ext=/ s/3perl/3pm/' \
      -e "/^cf_email=/ s/'.*'/''/" \
      -e "/^perladmin=/ s/'.*'/''/" \
      -i "${pkgdir}/${pacman_root}/usr/lib/perl5/$_baseversion/core_perl/Config_heavy.pl"

  ### CPAN Settings ###
  # Set CPAN default config to use the site directories.
  sed -e '/(makepl_arg =>/   s/""/"INSTALLDIRS=site"/' \
      -e '/(mbuildpl_arg =>/ s/""/"installdirs=site"/' \
      -i "${pkgdir}/${pacman_root}/usr/share/perl5/core_perl/CPAN/FirstTime.pm"

  # Profile script to set paths to perl scripts.
  install -D -m644 "${srcdir}/perlbin.sh" \
                   "${pkgdir}/${pacman_root}/etc/profile.d/perlbin.sh"
  # Profile script to set paths to perl scripts on csh. (FS#22441)
  install -D -m644 "${srcdir}/perlbin.csh" \
                  "${pkgdir}/${pacman_root}/etc/profile.d/perlbin.csh"
  # Profile script to set paths to perl scripts on fish. (FS#51191)
  install -D -m 755 "$srcdir/perlbin.fish" \
                  "$pkgdir/${pacman_root}/usr/share/fish/vendor_conf.d/perlbin.fish"

  # Add the dirs so new installs will already have them in PATH once they
  # install their first perl programm
  install -d -m755 "$pkgdir/${pacman_root}/usr/bin/vendor_perl"
  install -d -m755 "$pkgdir/${pacman_root}/usr/bin/site_perl"

  #(cd ${pkgdir}/usr/bin; mv perl${pkgver} perl)
  rm "$pkgdir/${pacman_root}/usr/bin/perl$pkgver"

  install -D -m755 -t "$pkgdir/${pacman_root}/usr/share/libalpm/scripts" "$srcdir/detect-old-perl-modules.sh"
  install -D -m644 -t "$pkgdir/${pacman_root}/usr/share/libalpm/hooks" "$srcdir/detect-old-perl-modules.hook"

  find "$pkgdir" -name perllocal.pod -delete
  find "$pkgdir" -name .packlist -delete
  find "$pkgdir" -name "*.0" -print -delete
}
