--- PKGBUILD
+++ PKGBUILD
@@ -6,0 +7,5 @@
+# note: we just let the rust bootstrap script download the compiler;
+# it seems like whatever we install with rustup manually can't compile shit
+# it also lets us not have rust depend on rust, which is kinda dumb.
+
+
@@ -8,12 +13,3 @@
-pkgname=(
-  rust
-  lib32-rust-libs
-  rust-musl
-  rust-aarch64-gnu
-  rust-aarch64-musl
-  rust-wasm
-  rust-src
-)
-
-
-epoch=1
+pkgname=(rust rust-wasm rust-src)
+
+
@@ -22,2 +18,2 @@
-arch=(x86_64)
-license=("Apache-2.0 OR MIT")
+arch=('x86_64' 'arm64')
+license=(MIT Apache)
@@ -24,0 +21 @@
+  !debug
@@ -26,0 +24 @@
+  !strip
@@ -29 +26,0 @@
-  bash
@@ -31 +27,0 @@
-  gcc
@@ -33 +28,0 @@
-  glibc
@@ -35 +30 @@
-  lld
+  libgit2
@@ -38 +32,0 @@
-  zlib
@@ -41,3 +34,0 @@
-  aarch64-linux-gnu-gcc
-  aarch64-linux-gnu-glibc
-  clang
@@ -45,2 +35,0 @@
-  lib32-gcc-libs
-  lib32-glibc
@@ -47,0 +37 @@
+  lld
@@ -49,2 +38,0 @@
-  musl
-  musl-aarch64
@@ -54 +42 @@
-  rust
+  pkg-config
@@ -56,5 +44 @@
-  wasm-component-ld
-)
-checkdepends=(
-  gdb
-  procps-ng
+  llvm-project-toolchain
@@ -75,5 +59,2 @@
-  # Use our ld.lld
-  0004-compiler-Use-ld.lld-by-default.patch
-
-  # Use our aarch64-linux-gnu-gcc
-  0005-compiler-Use-aarch64-linux-gnu-gcc-to-link-aarch64-t.patch
+  # Use our wasm-ld
+  0004-compiler-Use-wasm-ld-for-wasm-targets.patch
@@ -88,5 +69,3 @@
-  # Fix build with system rustc 1.90.0
-  # https://github.com/rust-lang/rust/issues/143765
-  0008-bootstrap-Workaround-for-1.90.0-stage0.patch
-)
-b2sums=('7bb22f814f1ccf08bd8c57a0c81d94b5a5850b8e20c563f1da7b1a37bb390b5ed82ff448dfc7738e1990653c798f6edaacc410483b95007691e717d55a6b10de'
+  disable-time-machine-fuckery.patch
+)
+b2sums=('5cc32e9e7f766ec3631f369c1b60d4a9bcb39c21ede5ef6364cccf32d0d4105cab3fd10dfdf5f38db304db0dc771ae783303ed94d6277013770b59ee569a48c1'
@@ -94,5 +73,4 @@
-        '0d1dc9024d53f669ceeb5fb61879527663c99ef3d7bd9bcb1e24dc8de15605dfc4820be23e7114c810f91eeb9d0d9e2107d507584af78a3ef2ea48e28f9d16b9'
-        '81d39b0ceadfccdfea647eafbfd13beefabcf95bf476e2bfbd3cfcc16a5c4f33fef9cb946da2324f03fc2c44636101fb2b3010cb3527185f64041bc99c665f06'
-        '248747c078b930f700a0685638663d1337b289e6a46d7feca8f017dfb316c22574656bf84888f7ae7e2aab68f59190eca61bf17a780753823ffc4fbc91ff785d'
-        '645f42c6c831c5000b1b174b9d1693e99d12e55f166d5a3d6f8843801e7f10c3079be035bfb5b04f7d51400157a5cbb63874b6728148f2cb7e75f7868a77b818'
-        '40e14ccc8b5dfff5d87f43a8763d1d2a49435c7a76633a920648a43dd25df0ab056107722ccdc574d9d603322699c6f3990878e19ab25d5e0117689d8f6b99b8'
+        '17e7f6e73936137507e387cd2761b0b98f9457391e4f534beb872effaa9f442e72351bb39d5e34963d9f18a31fd9f07139cfbde4df9c4c1d8cc6e5d3a7f2c8f7'
+        'fed39e683a0fa4b7730c629f2453bccb70d2b37329ee8853e0c8e8cbc07a227a6c15bdf81c7285a2a2debeffde24ef14abcfccee6383024ac6bff7405e725482'
+        '1f664dc8156ebe48ae49e7651312ca8879b40fb65471bd9e4180e84fc8b2f6e94b50b7ff7db598e8f298058fae7bcc591532fe087084330650c69df131d2bb85'
+        '2317343e6b986d1ec1fb6d035fb6d8933245704b5be1b3e4a032ad14300d8a338087c52e53a6dff4ceda52232ce7f21dd8ad536c9d4da04faee6a9b79a9670b6'
@@ -100,2 +78,2 @@
-        '04a5a67ee8d2a41d81d663b0d81e63495ea4c3455d8dce97c94f2722749be0c2342c715da44f22b1c8fcd04890d980cb865f0e6980f2b8dae886848b4e870e27'
-        '440465da4823dc58e67e2f608872dfeb52727673d8435280bbe79f4a32213c7dacf8761da1eef1f65eec3778a9f07f01d67a2134838ff68c73dfe639a7d5e7da')
+        'f7f43c42856be95b658963275f6ebd94a500f24f23c925e3d9e5fe917f6d509bfd75d2fca072c987e93cd7d5a3776800ba633406cd77fe387b39252b5b7dfbc2'
+        '6ea472d7d8afd0688dac305decb818b3779277b87058cb8f9207adc01881e7b51474f8c52fc4c21247060ede2614a54183446b0290987db02bb83a0233149b06')
@@ -106,2 +84,3 @@
-# Make sure the duplication in rust-wasm is found
-COMPRESSZST+=(--long)
+_arch1=$(clang -print-target-triple)
+_arch2=${_arch1%%.*}
+_arch=$(echo ${_arch2} | grep -o '.*[^0-9]' | sed -e 's/arm64/aarch64/')
@@ -112,9 +91,10 @@
-  local src
-  for src in "${source[@]}"; do
-    src="${src%%::*}"
-    src="${src##*/}"
-    src="${src%.zst}"
-    [[ $src = *.patch ]] || continue
-    echo "Applying patch $src..."
-    patch -Np1 < "../$src"
-  done
+  patch -Np1 -i ../0001-bootstrap-Change-libexec-dir.patch
+
+  # Put bash completions where they belong
+  patch -Np1 -i ../0002-bootstrap-Change-bash-completion-dir.patch
+
+  # Use our wasm-ld
+  patch -Np1 -i ../0004-compiler-Use-wasm-ld-for-wasm-targets.patch
+
+  # disable time machine fuckery
+  patch -Np1 -i ../disable-time-machine-fuckery.patch
@@ -123 +103 @@
-# see src/bootstrap/defaults/
+change-id = 142379
@@ -126,3 +105,0 @@
-# see src/bootstrap/src/utils/change_tracker.rs
-change-id = 144675
-
@@ -129,0 +107 @@
+link-shared = true
@@ -131 +108,0 @@
-link-shared = true
@@ -134 +111 @@
-description = "Arch Linux $pkgbase $epoch:$pkgver-$pkgrel"
+host = ["${_arch}"]
@@ -136,5 +113 @@
-  "x86_64-unknown-linux-gnu",
-  "i686-unknown-linux-gnu",
-  "x86_64-unknown-linux-musl",
-  "aarch64-unknown-linux-gnu",
-  "aarch64-unknown-linux-musl",
+  "${_arch}",
@@ -142 +114,0 @@
-  "wasm32v1-none",
@@ -147,3 +118,0 @@
-cargo = "/usr/bin/cargo"
-rustc = "/usr/bin/rustc"
-rustfmt = "/usr/bin/rustfmt"
@@ -154,0 +124 @@
+  "rustfmt",
@@ -156,2 +125,0 @@
-  "rustfmt",
-  "rust-analyzer-proc-macro-srv",
@@ -159,0 +128,2 @@
+  "rust-demangler",
+  "rust-analyzer-proc-macro-srv",
@@ -161 +131,3 @@
-sanitizers = true
+
+# TODO: re-enable sanitisers
+sanitizers = false
@@ -168 +140,2 @@
-prefix = "/usr"
+prefix = "${pacman_root}/usr"
+sysconfdir = "${pacman_root}/etc"
@@ -171 +144,14 @@
-codegen-units = 1
+# debuginfo-level-std = 2
+channel = "stable"
+description = "(macos-pacman) $pkgname $pkgver-$pkgrel"
+
+# note: we'll fix the rpath after-the-fact
+rpath = true
+backtrace-on-ice = true
+remap-debuginfo = true
+jemalloc = true
+
+# LLVM crashes when passing an object through ThinLTO twice.  This is triggered
+# when using rust code in cross-language LTO if libstd was built using ThinLTO.
+# http://blog.llvm.org/2019/09/closing-gap-cross-language-lto-between.html
+# https://github.com/rust-lang/rust/issues/54872
@@ -173,5 +159,4 @@
-debuginfo-level = 2
-debuginfo-level-std = 2
-channel = "stable"
-rpath = false
-frame-pointers = true
+
+# musl target produces warnings
+deny-warnings = false
+
@@ -181,5 +165,0 @@
-deny-warnings = false
-backtrace-on-ice = true
-remap-debuginfo = false
-jemalloc = true
-lto = "fat"
@@ -189,40 +169,8 @@
-compression-profile = "fast"
-
-[target.x86_64-unknown-linux-gnu]
-cc = "/usr/bin/gcc"
-cxx = "/usr/bin/g++"
-ar = "/usr/bin/gcc-ar"
-ranlib = "/usr/bin/gcc-ranlib"
-llvm-config = "/usr/bin/llvm-config"
-
-[target.i686-unknown-linux-gnu]
-cc = "/usr/bin/gcc"
-cxx = "/usr/bin/g++"
-ar = "/usr/bin/gcc-ar"
-ranlib = "/usr/bin/gcc-ranlib"
-
-[target.x86_64-unknown-linux-musl]
-cc = "/usr/bin/musl-gcc"
-cxx = "/usr/bin/g++"
-ar = "/usr/bin/gcc-ar"
-ranlib = "/usr/bin/gcc-ranlib"
-sanitizers = false
-musl-root = "/usr/lib/musl"
-
-[target.aarch64-unknown-linux-gnu]
-cc = "/usr/bin/aarch64-linux-gnu-gcc"
-cxx = "/usr/bin/aarch64-linux-gnu-g++"
-ar = "/usr/bin/aarch64-linux-gnu-gcc-ar"
-ranlib = "/usr/bin/aarch64-linux-gnu-gcc-ranlib"
-linker = "/usr/bin/aarch64-linux-gnu-gcc"
-default-linker = "aarch64-linux-gnu-gcc"
-
-[target.aarch64-unknown-linux-musl]
-cc = "/usr/aarch64-linux-musl/bin/musl-gcc"
-cxx = "/usr/bin/aarch64-linux-gnu-g++"
-ar = "/usr/bin/aarch64-linux-gnu-gcc-ar"
-ranlib = "/usr/bin/aarch64-linux-gnu-gcc-ranlib"
-linker = "/usr/bin/aarch64-linux-gnu-gcc"
-default-linker = "aarch64-linux-gnu-gcc"
-sanitizers = false
-musl-root = "/usr/aarch64-linux-musl/lib/musl"
+
+[target.${_arch}]
+cc = "${pacman_root}/usr/bin/clang"
+cxx = "${pacman_root}/usr/bin/clang++"
+ar = "${pacman_root}/usr/bin/llvm-ar"
+ranlib = "${pacman_root}/usr/bin/llvm-ranlib"
+llvm-config = "${pacman_root}/usr/bin/llvm-config"
+
@@ -231,5 +179,6 @@
-cc = "/usr/bin/clang"
-cxx = "/usr/bin/clang++"
-ar = "/usr/bin/llvm-ar"
-ranlib = "/usr/bin/llvm-ranlib"
-linker = "/usr/bin/wasm-ld"
+cc = "${pacman_root}/usr/bin/clang"
+cxx = "${pacman_root}/usr/bin/clang++"
+ar = "${pacman_root}/usr/bin/llvm-ar"
+ranlib = "${pacman_root}/usr/bin/llvm-ranlib"
+linker = "${pacman_root}/usr/bin/wasm-ld"
+llvm-config = "${pacman_root}/usr/bin/llvm-config"
@@ -240,6 +189,8 @@
-[target.wasm32v1-none]
-cc = "/usr/bin/clang"
-cxx = "/usr/bin/clang++"
-ar = "/usr/bin/llvm-ar"
-ranlib = "/usr/bin/llvm-ranlib"
-linker = "/usr/bin/wasm-ld"
+[target.wasm32-wasip1]
+wasi-root = "${pacman_root}/usr/share/wasi-sysroot"
+cc = "${pacman_root}/usr/bin/clang"
+cxx = "${pacman_root}/usr/bin/clang++"
+ar = "${pacman_root}/usr/bin/llvm-ar"
+ranlib = "${pacman_root}/usr/bin/llvm-ranlib"
+linker = "${pacman_root}/usr/bin/wasm-ld"
+llvm-config = "${pacman_root}/usr/bin/llvm-config"
@@ -250,6 +201,8 @@
-[target.wasm32-wasip1]
-cc = "/usr/bin/clang"
-cxx = "/usr/bin/clang++"
-ar = "/usr/bin/llvm-ar"
-ranlib = "/usr/bin/llvm-ranlib"
-linker = "/usr/bin/wasm-ld"
+[target.wasm32-wasip1-threads]
+wasi-root = "${pacman_root}/usr/share/wasi-sysroot"
+cc = "${pacman_root}/usr/bin/clang"
+cxx = "${pacman_root}/usr/bin/clang++"
+ar = "${pacman_root}/usr/bin/llvm-ar"
+ranlib = "${pacman_root}/usr/bin/llvm-ranlib"
+linker = "${pacman_root}/usr/bin/wasm-ld"
+llvm-config = "${pacman_root}/usr/bin/llvm-config"
@@ -259,8 +212,9 @@
-wasi-root = "/usr/share/wasi-sysroot"
-
-[target.wasm32-wasip1-threads]
-cc = "/usr/bin/clang"
-cxx = "/usr/bin/clang++"
-ar = "/usr/bin/llvm-ar"
-ranlib = "/usr/bin/llvm-ranlib"
-linker = "/usr/bin/wasm-ld"
+
+[target.wasm32-wasip2]
+wasi-root = "${pacman_root}/usr/share/wasi-sysroot"
+cc = "${pacman_root}/usr/bin/clang"
+cxx = "${pacman_root}/usr/bin/clang++"
+ar = "${pacman_root}/usr/bin/llvm-ar"
+ranlib = "${pacman_root}/usr/bin/llvm-ranlib"
+linker = "${pacman_root}/usr/bin/wasm-ld"
+llvm-config = "${pacman_root}/usr/bin/llvm-config"
@@ -270,12 +224 @@
-wasi-root = "/usr/share/wasi-sysroot"
-
-[target.wasm32-wasip2]
-cc = "/usr/bin/clang"
-cxx = "/usr/bin/clang++"
-ar = "/usr/bin/llvm-ar"
-ranlib = "/usr/bin/llvm-ranlib"
-linker = "/usr/bin/wasm-ld"
-default-linker = "wasm-ld"
-sanitizers = false
-profiler = false
-wasi-root = "/usr/share/wasi-sysroot"
+
@@ -288 +231 @@
-    d="$srcdir/$p/${f#$pkgdir/}"
+    d="$srcdir/$p/$f"
@@ -290,2 +233,2 @@
-    mv "$f" "$d"
-    rmdir -p --ignore-fail-on-non-empty "$(dirname "$f")"
+    mv -f "$f" "$d"
+    rmdir -p "$(dirname "$f")" || :
@@ -297,0 +241,3 @@
+  export CFLAGS="${CFLAGS/-march=native/}"
+  export CXXFLAGS="${CXXFLAGS/-march=native/}"
+
@@ -299,3 +245,3 @@
-  unset CFLAGS CXXFLAGS LDFLAGS
-
-  DESTDIR="$srcdir/dest-rust" python ./x.py install -j "$(nproc)"
+
+  rm -fr "$srcdir/dest-rust"
+  DESTDIR="$srcdir/dest-rust" python ./x.py install -j"$(getconf _NPROCESSORS_ONLN)"
@@ -304,0 +251,3 @@
+  local _root
+  _root=${pacman_root#/}
+
@@ -306,7 +255,9 @@
-  rm -v usr/lib/rustlib/{components,install.log,rust-installer-version,uninstall.sh}
-  rm -v usr/lib/rustlib/manifest-*
-
-  # licenses for main rust package
-  local ldir="usr/share/licenses/rust" f d
-  mkdir -p "$ldir"
-  for f in usr/share/doc/*/{COPYRIGHT,LICENSE}*; do
+  rm -f ${_root}/usr/bin/*.old
+  rm -f ${_root}/usr/lib/rustlib/{components,install.log,rust-installer-version,uninstall.sh}
+  rm -f ${_root}/usr/lib/rustlib/manifest-*
+
+  local ldir="${_root}/usr/share/licenses/rust"
+  local f d
+
+  mkdir -p ${ldir}
+  for f in ${_root}/usr/share/doc/*/{COPYRIGHT,LICENSE}*; do
@@ -318,21 +269,5 @@
-    rmdir -p --ignore-fail-on-non-empty "$d"
-  done
-
-  # rustbuild always installs copies of the shared libraries to /usr/lib,
-  # overwrite them with symlinks to the per-architecture versions
-  mkdir -pv usr/lib32
-  ln -srvft usr/lib   usr/lib/rustlib/x86_64-unknown-linux-gnu/lib/*.so
-  ln -srvft usr/lib32 usr/lib/rustlib/i686-unknown-linux-gnu/lib/*.so
-
-  # Symlink the "self-contained" linker to our system lld
-  mkdir -pv usr/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld
-  ln -srvf  usr/bin/lld          usr/lib/rustlib/x86_64-unknown-linux-gnu/bin/rust-lld
-  ln -srvf  usr/bin/llvm-objcopy usr/lib/rustlib/x86_64-unknown-linux-gnu/bin/rust-objcopy
-  ln -srvft usr/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld usr/bin/{ld.lld,ld64.lld,lld-link,wasm-ld}
-
-  _pick dest-i686 usr/lib/rustlib/i686-unknown-linux-gnu usr/lib32
-  _pick dest-musl usr/lib/rustlib/x86_64-unknown-linux-musl
-  _pick dest-aarch64-gnu usr/lib/rustlib/aarch64-unknown-linux-gnu
-  _pick dest-aarch64-musl usr/lib/rustlib/aarch64-unknown-linux-musl
-  _pick dest-wasm usr/lib/rustlib/wasm32{,v1}-*
-  _pick dest-src  usr/lib/rustlib/src
+    rmdir -p "$d" || :
+  done
+
+  _pick dest-wasm ${_root}/usr/lib/rustlib/wasm32-*
+  _pick dest-src  ${_root}/usr/lib/rustlib/src
@@ -352 +286,0 @@
-    'rust-docs<1:1.56.1-3'
@@ -358 +291,0 @@
-    'rust-docs<1:1.56.1-3'
@@ -363,21 +296,39 @@
-}
-
-package_lib32-rust-libs() {
-  pkgdesc="32-bit target and libraries for Rust"
-  depends=(
-    lib32-gcc-libs
-    lib32-glibc
-    rust
-  )
-  provides=(lib32-rust)
-  conflicts=(lib32-rust)
-  replaces=(lib32-rust)
-
-  cp -a dest-i686/* "$pkgdir"
-
-  install -Dt "$pkgdir/usr/share/licenses/$pkgname" -m644 \
-    rustc-$pkgver-src/{COPYRIGHT,LICENSE-MIT}
-}
-
-package_rust-musl() {
-  pkgdesc="Musl target for Rust"
+
+  local _root
+  _root=${pacman_root#/}
+
+  pushd $pkgdir > /dev/null
+    # rustbuild always installs copies of the shared libraries to /usr/lib,
+    # overwrite them with symlinks to the per-architecture versions
+    ln -sf ${pacman_root}/usr/lib/rustlib/${_arch}/lib/*.dylib ${_root}/usr/lib
+  popd > /dev/null
+
+  # fix those rpaths
+  msg 'Fixing dylib names'
+  local _lib _libs
+  IFS=$'\n' read -r -d '' -a _libs < <(find ${pkgdir}/${pacman_root}/usr/lib -iname '*.dylib' \
+    -o -iname "rust-analyzer-proc-macro-srv") || true
+
+  for _lib in "${_libs[@]}"; do
+    fix_rpath_v2 "${_lib}"
+  done
+
+  local _exe _exes
+  IFS=$'\n' read -r -d '' -a _exes < <(find ${pkgdir}/${pacman_root}/usr/bin -type f) || true
+
+  for _exe in "${_exes[@]}"; do
+    fix_rpath_v2 "${_exe}"
+  done
+
+  msg 'Codesigning modified dylibs'
+
+  _libs=("${pkgdir}/${pacman_root}/usr/lib/rustlib/${_arch}/lib/librustc-stable_rt."{tsan,asan,lsan}.dylib)
+  for _lib in "${_libs[@]}"; do
+    if [ -f "${_lib}" ]; then
+      codesign --force -s - "${_lib}"
+    fi
+  done
+}
+
+package_rust-src() {
+  pkgdesc="Source code for the Rust standard library"
@@ -386,31 +337,4 @@
-  cp -a dest-musl/* "$pkgdir"
-
-  install -Dt "$pkgdir/usr/share/licenses/$pkgname" -m644 \
-    rustc-$pkgver-src/{COPYRIGHT,LICENSE-MIT}
-}
-
-package_rust-aarch64-gnu() {
-  pkgdesc="AArch64 GNU target for Rust"
-  depends=(
-    aarch64-linux-gnu-gcc
-    aarch64-linux-gnu-glibc
-    rust
-  )
-
-  cp -a dest-aarch64-gnu/* "$pkgdir"
-
-  install -Dt "$pkgdir/usr/share/licenses/$pkgname" -m644 \
-    rustc-$pkgver-src/{COPYRIGHT,LICENSE-MIT}
-}
-
-package_rust-aarch64-musl() {
-  pkgdesc="AArch64 Musl target for Rust"
-  depends=(
-    aarch64-linux-gnu-gcc
-    rust
-  )
-
-  cp -a dest-aarch64-musl/* "$pkgdir"
-
-  install -Dt "$pkgdir/usr/share/licenses/$pkgname" -m644 \
-    rustc-$pkgver-src/{COPYRIGHT,LICENSE-MIT}
+  cp -a dest-src/* "$pkgdir"
+
+  mkdir -p "$pkgdir/${pacman_root}/usr/share/licenses"
+  ln -s rust "$pkgdir/${pacman_root}/usr/share/licenses/$pkgname"
@@ -421,0 +346 @@
+    lld
@@ -423 +347,0 @@
-    wasm-component-ld
@@ -428,12 +352,3 @@
-  install -Dt "$pkgdir/usr/share/licenses/$pkgname" -m644 \
-    rustc-$pkgver-src/{COPYRIGHT,LICENSE-MIT}
-}
-
-package_rust-src() {
-  pkgdesc="Source code for the Rust standard library"
-  depends=(rust)
-
-  cp -a dest-src/* "$pkgdir"
-
-  install -Dt "$pkgdir/usr/share/licenses/$pkgname" -m644 \
-    rustc-$pkgver-src/{COPYRIGHT,LICENSE-MIT}
+  mkdir -p "$pkgdir/${pacman_root}/usr/share/licenses"
+  ln -s rust "$pkgdir/${pacman_root}/usr/share/licenses/$pkgname"
+
